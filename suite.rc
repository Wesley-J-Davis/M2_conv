#!Jinja2
[meta]
    title = "M2 Conv Obs"

[scheduling]
    initial cycle point = 19800101T0000
    final cycle point = 19800601T0000
    
    [[dependencies]]
        [[[P1M]]]
            graph = """
                debug => move_jobs:succeed => process_jobs:succeed => metric_jobs:succeed => combine_jobs & hourly_jobs
                hourly_jobs[-P1M]:succeed => debug
            """

[runtime]
    [[root]]  # Inherited by all tasks
        [[[environment]]]
            STORAGE_DIR = /discover/nobackup/projects/gmao/merra2/data/obs/.WORK/products_revised
            HOST_DIR = /discover/nobackup/projects/gmao/merra2/data/obs/work_dir_wjd
            SCRIPT_DIR = /discover/nobackup/dao_ops/TEST/M2_GRITAS/github_repo/M2_GRITAS/bin

    [[debug]]
        script = """
            echo "DEBUG: Running for cycle ${CYLC_TASK_CYCLE_POINT}"
            echo "Initial point: ${CYLC_WORKFLOW_INITIAL_CYCLE_POINT}"
            echo "Final point: ${CYLC_WORKFLOW_FINAL_CYCLE_POINT}"
        """

    [[move_jobs]]
        script = """
        set -e  
        set -x  
        
        echo "Starting move_jobs script"
        echo "Current directory: $(pwd)"
        echo "CYLC_TASK_CYCLE_POINT: '${CYLC_TASK_CYCLE_POINT}'"
        
        # Check if directory exists before changing to it
        TARGET_DIR="/discover/nobackup/dao_ops/TEST/M2_GRITAS/github_repo/M2_GRITAS/bin"
        if [[ -d "$TARGET_DIR" ]]; then
            echo "Directory exists, changing to: $TARGET_DIR"
            cd "$TARGET_DIR"
            echo "Successfully changed to: $(pwd)"
        else
            echo "ERROR: Directory does not exist: $TARGET_DIR"
            exit 1
        fi
        SLURM_LOG_DIR=${CYLC_TASK_WORK_DIR}
        move_job_ids=()
        SYNOP_TIMES=(00 06 12 18)
        echo $CYLC_TASK_CYCLE_POINT
        YEAR_TABLE=$(echo ${CYLC_TASK_CYCLE_POINT} | cut -c 1-6)
        YYYY=$(echo $YEAR_TABLE | cut -c 1-4)
        if [[ $YYYY -ge 1979 && $YYYY -lt 1991 ]]; then
            export ExpID=d5124_m2_jan79
        elif [[ $YYYY -ge 1991 && $YYYY -lt 2000 ]]; then
            export ExpID=d5124_m2_jan91
        elif [[ $YYYY -ge 2000 && $YYYY -lt 2010 ]]; then
            export ExpID=d5124_m2_jan00
        elif [[ $YYYY -ge 2010 && $YYYY -lt 2026 ]]; then
            export ExpID=d5124_m2_jan10
        fi
        MM=$(echo $YEAR_TABLE | cut -c 5-6)
        mm=$(printf $((10#$MM )))
        YYYY=$(echo $YEAR_TABLE | cut -c 1-4)
        DAY_TABLE=(31 28 31 30 31 30 31 31 30 31 30 31)
        if [ "$MM" -eq "02" ]; then
            num_check=$( /usr/bin/perl /home/dao_ops/bin/tick ${YEAR_TABLE}${DAY_TABLE[$MM-1]} )
            check_num=$(echo $num_check | cut -c 7-8 )
            echo $check_num
            if [ $check_num -eq "29" ]; then
                DAY_TABLE=(31 29 31 30 31 30 31 31 30 31 30 31 )
            fi
        fi
        for SYNOP in "${SYNOP_TIMES[@]}"; do
            move_conv=$(sbatch --parsable \
                -J ${YEAR_TABLE}.${SYNOP}.conv.move \
                -o ${SLURM_LOG_DIR}/${SYNOP}.move.log \
                --export=YEAR_TABLE=${YEAR_TABLE},INSTRUMENT_TABLE=conv,ExpID=${ExpID},SYNOP=${SYNOP} \
                --time=2:00:00 \
                --nodes=1 \
                --ntasks-per-node=1 \
                --cpus-per-task=1 \
            ${SCRIPT_DIR}/move_conventionals.j)
            move_job_ids+=($move_conv)
            echo "    - Move job: $move_conv"  >&2
        done

        move_deps=$(IFS=':'; echo "${move_job_ids[*]}")
        echo "Waiting for jobs: $move_deps"

        for job_id in "${move_job_ids[@]}"; do
            while squeue -j $job_id >/dev/null 2>&1; do
                sleep 30
            done
        done
        echo "All move jobs completed"
        """

    [[process_jobs]]
        script = """
            set -x
            cd ${SCRIPT_DIR}
            process_job_ids=()
            SYNOP_TIMES=(00 06 12 18)
            export YEAR_TABLE=$(echo ${CYLC_TASK_CYCLE_POINT} | cut -c 1-6)
            YYYY=$(echo $YEAR_TABLE | cut -c 1-4)
            if [[ $YYYY -ge 1979 && $YYYY -lt 1991 ]]; then
                    export ExpID=d5124_m2_jan79
            elif [[ $YYYY -ge 1991 && $YYYY -lt 2000 ]]; then
                    export ExpID=d5124_m2_jan91
            elif [[ $YYYY -ge 2000 && $YYYY -lt 2010 ]]; then
                    export ExpID=d5124_m2_jan00
            elif [[ $YYYY -ge 2010 && $YYYY -lt 2026 ]]; then
                    export ExpID=d5124_m2_jan10
            fi
            MM=$(echo $YEAR_TABLE | cut -c 5-6)
            mm=$(printf $((10#$MM )))
            YYYY=$(echo $YEAR_TABLE | cut -c 1-4)
            DAY_TABLE=(31 28 31 30 31 30 31 31 30 31 30 31)

            if [ "$MM" -eq "02" ]; then
                    num_check=$( /usr/bin/perl /home/dao_ops/bin/tick ${YEAR_TABLE}${DAY_TABLE[$MM-1]} )
                    check_num=$(echo $num_check | cut -c 7-8 )
                    echo $check_num
                    if [ $check_num -eq "29" ]; then
                        DAY_TABLE=(31 29 31 30 31 30 31 31 30 31 30 31 )
                    fi
            fi

            SLURM_LOG_DIR=${CYLC_TASK_WORK_DIR}

            for SYNOP in "${SYNOP_TIMES[@]}"; do
                local process_job=$(sbatch --parsable \
                    -J ${YEAR_TABLE}.conv.${SYNOP}.process \
                    -o ${SLURM_LOG_DIR}/${SYNOP}.process.log \
                    --export=YEAR_TABLE=${YEAR_TABLE},INSTRUMENT_TABLE=conv,SYNOP_TABLE=${SYNOP},ExpID=$ExpID \
                    --time=1:00:00 \
                    --nodes=1 \
                    --ntasks-per-node=8 \
                    --cpus-per-task=1 \
                    ${SCRIPT_DIR}/process_gritas_conventionals.j)
                    process_job_ids+=($process_job)
                    echo "    - Process job for SYNOP $SYNOP: $process_job"  >&2
            done
        
            process_deps=$(IFS=':'; echo "${process_job_ids[*]}")

            echo "Waiting for jobs: $process_deps"

            for job_id in "${process_job_ids[@]}"; do
                    while squeue -j $job_id >/dev/null 2>&1; do
                            sleep 30
                    done
            done
            echo "All $process_deps jobs completed"

        """

    [[metric_jobs]]
        script = """
            set -x
            metric_job_ids=()
            export YEAR_TABLE=$(echo ${CYLC_TASK_CYCLE_POINT} | cut -c 1-6)
            SLURM_LOG_DIR=${CYLC_TASK_WORK_DIR}
            for metric in obrate means rms; do
                metric_job=$(sbatch --parsable \
                    -J ${YEAR_TABLE}.conv.${metric} \
                    -o ${SLURM_LOG_DIR}/${metric}.log \
                    --export=YEAR_TABLE=${YEAR_TABLE},METRIC=${metric} \
                    --nodes=1 \
                    --ntasks-per-node=1 \
                    --cpus-per-task=1 \
                    --time=1:30:00 \
                    ${SCRIPT_DIR}/process_conv_means.j)
                metric_job_ids+=($metric_job)
                echo "    - metric job: $metric_job"
            done
            metric_deps=$(IFS=':'; echo "${metric_job_ids[*]}")
            for job_id in "${metric_job_ids[@]}"; do
                    while squeue -j $job_id >/dev/null 2>&1; do
                            sleep 30
                    done
            done
            echo "All $metric_deps jobs completed"

        """

    [[combine_jobs]]
        script = """
                set -x
                cd ${SCRIPT_DIR}

                SYNOP_TIMES=(00 06 12 18)
                combine_job_ids=()
                export YEAR_TABLE=$(echo ${CYLC_TASK_CYCLE_POINT} | cut -c 1-6)
                YYYY=$(echo $YEAR_TABLE | cut -c 1-4)
                if [[ $YYYY -ge 1979 && $YYYY -lt 1991 ]]; then
                        export ExpID=d5124_m2_jan79
                elif [[ $YYYY -ge 1991 && $YYYY -lt 2000 ]]; then
                        export ExpID=d5124_m2_jan91
                elif [[ $YYYY -ge 2000 && $YYYY -lt 2010 ]]; then
                        export ExpID=d5124_m2_jan00
                elif [[ $YYYY -ge 2010 && $YYYY -lt 2026 ]]; then
                        export ExpID=d5124_m2_jan10
                fi
                MM=$(echo $YEAR_TABLE | cut -c 5-6)
                mm=$(printf $((10#$MM )))
                YYYY=$(echo $YEAR_TABLE | cut -c 1-4)
                DAY_TABLE=(31 28 31 30 31 30 31 31 30 31 30 31)

                if [ "$MM" -eq "02" ]; then
                        num_check=$( /usr/bin/perl /home/dao_ops/bin/tick ${YEAR_TABLE}${DAY_TABLE[$MM-1]} )
                        check_num=$(echo $num_check | cut -c 7-8 )
                        echo $check_num
                        if [ $check_num -eq "29" ]; then
                                DAY_TABLE=(31 29 31 30 31 30 31 31 30 31 30 31 )
                        fi
                fi
            SLURM_LOG_DIR=${CYLC_TASK_WORK_DIR}

            for SYNOP in "${SYNOP_TIMES[@]}"; do
                combine_job=$(sbatch --parsable \
                           -J ${YEAR_TABLE}.conv.${SYNOP}.combine \
                           -o ${SLURM_LOG_DIR}/${SYNOP}.conv.combine.log \
                           --export=YEAR_TABLE=${YEAR_TABLE},INSTRUMENT_TABLE=conv,SYNOP_TABLE=${SYNOP},ExpID=$ExpID,HOST_DIR=${HOST_DIR} \
                           --time=1:00:00 \
                           --nodes=1 \
                           --ntasks-per-node=1 \
                           --cpus-per-task=1 \
                           ${SCRIPT_DIR}/combine_conv_output.j)
                    combine_job_ids+=($combine_job)
                    echo "    - Combine job for SYNOP $SYNOP: $combine_job"  >&2
            done
        
        combine_deps=$(IFS=':'; echo "${combine_job_ids[*]}")
        
        all_combine_job=$(sbatch --parsable \
                -J ${YEAR_TABLE}.conv.all.combine \
                -o ${SLURM_LOG_DIR}/conv.all.combine.log \
                --dependency=afterok:${combine_deps} \
                --export=YEAR_TABLE=${YEAR_TABLE},INSTRUMENT_TABLE=conv,SYNOP_TABLE=all,ExpID=$ExpID,HOST_DIR=${HOST_DIR} \
                --time=1:00:00 \
                --nodes=1 \
                --ntasks-per-node=1 \
                --cpus-per-task=1 \
                ${SCRIPT_DIR}/combine_conv_output.j)
       echo "    - All-SYNOP combine job: $all_combine_job"  >&2

       echo "All combine completed"

        """

    [[hourly_jobs]]
        script = """
            set -x
            cd ${SCRIPT_DIR}

            SYNOP_TIMES=(00 06 12 18)
            export YEAR_TABLE=$(echo ${CYLC_TASK_CYCLE_POINT} | cut -c 1-6)
            YYYY=$(echo $YEAR_TABLE | cut -c 1-4)
            if [[ $YYYY -ge 1979 && $YYYY -lt 1991 ]]; then
                    export ExpID=d5124_m2_jan79
            elif [[ $YYYY -ge 1991 && $YYYY -lt 2000 ]]; then
                    export ExpID=d5124_m2_jan91
            elif [[ $YYYY -ge 2000 && $YYYY -lt 2010 ]]; then
                    export ExpID=d5124_m2_jan00
            elif [[ $YYYY -ge 2010 && $YYYY -lt 2026 ]]; then
                    export ExpID=d5124_m2_jan10
            fi
            MM=$(echo $YEAR_TABLE | cut -c 5-6)
            mm=$(printf $((10#$MM )))
            YYYY=$(echo $YEAR_TABLE | cut -c 1-4)
            DAY_TABLE=(31 28 31 30 31 30 31 31 30 31 30 31)

            if [ "$MM" -eq "02" ]; then
                    num_check=$( /usr/bin/perl /home/dao_ops/bin/tick ${YEAR_TABLE}${DAY_TABLE[$MM-1]} )
                    check_num=$(echo $num_check | cut -c 7-8 )
                    echo $check_num
                    if [ $check_num -eq "29" ]; then
                            DAY_TABLE=(31 29 31 30 31 30 31 31 30 31 30 31 )
                    fi
            fi
            export DAYS_IN_MONTH=${DAY_TABLE[$mm-1]}
            hourly_array_size=$((DAYS_IN_MONTH * 4 ))
            SLURM_LOG_DIR=${CYLC_TASK_WORK_DIR}
            hourly_job=$(sbatch --parsable \
                --array=1-${hourly_array_size}%15 \
                -t 02:00:00 \
                -J ${YEAR_TABLE}.conv.hourly \
                -o ${SLURM_LOG_DIR}/conv.hourly.%A_%a.log \
                --export=YEAR_TABLE=${YEAR_TABLE},INSTRUMENT_TABLE=conv,YYYY=${YYYY},MM=${MM},DAYS_IN_MONTH=${DAYS_IN_MONTH},HOST_DIR=${HOST_DIR},STORAGE_DIR=${STORAGE_DIR},ExpID=$ExpID \
                --nodes=1 \
                --ntasks-per-node=1 \
                --cpus-per-task=1 \
                ${SCRIPT_DIR}/combine_hourly_conv_array.j)

                echo "    - Hourly job array: $hourly_job"  >&2

        """
